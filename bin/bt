#!/usr/bin/env bash

source bot-funcs.sh

echo "bot-test"
echo

init_oolite_window

pause_shell "Press [Enter] when you're ready"

# Width and height of 'in hold' market items
IN_HOLD_W=25
IN_HOLD_H=18

# Origin of first item (food) on market screen
ITEM_X=551
ITEM_Y=130

# Origin of items on market screen. Because the height is actually
# somewhere between 18 and 19 pixels, the starting point of some
# items is incremented by 1 occasionally.
FOOD_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
TEXTILES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
RADIOACTIVES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
SLAVES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
LIQUOR_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H + 1))
LUXURIES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
NARCOTICS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
COMPUTERS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
MACHINERY_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
ALLOYS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
FIREARMS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H + 1))
FURS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
MINERALS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
GOLD_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
PLATINUM_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
GEMSTONES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H + 1))
ALIENITEMS_Y=$ITEM_Y

#
# Generate and store SHAs of the current 'in hold' cargo state for each item
#
get_current_cargo_state() {
    foodSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $FOOD_Y | sha256sum)
    textilesSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $TEXTILES_Y | sha256sum)
    radioactivesSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $RADIOACTIVES_Y | sha256sum)
    slavesSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $SLAVES_Y | sha256sum)
    liquorSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $LIQUOR_Y | sha256sum)
    luxuriesSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $LUXURIES_Y | sha256sum)
    narcoticsSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $NARCOTICS_Y | sha256sum)
    computersSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $COMPUTERS_Y | sha256sum)
    machinerySHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $MACHINERY_Y | sha256sum)
    alloysSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $ALLOYS_Y | sha256sum)
    firearmsSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $FIREARMS_Y | sha256sum)
    fursSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $FURS_Y | sha256sum)
    mineralsSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $MINERALS_Y | sha256sum)
    goldSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $GOLD_Y | sha256sum)
    platinumSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $PLATINUM_Y | sha256sum)
    gemstonesSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $GEMSTONES_Y | sha256sum)
    alienitemsSHA=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $ALIENITEMS_Y | sha256sum)
}


write_snapshot() {
    # Store the args in named vars
    local width=$1
    local height=$2
    local originX=$3
    local originY=$4
    local fname=$5

    local cropStr="${width}x${height}+${originX}+${originY}"

    # Capture a snapshot of the window
    xwd -name "$WIN_NAME" -silent | convert xwd:- -depth 8 -crop $cropStr $fname
}

cap_to_img() {
    local originX=$1
    local originY=$2
    local fname=$3
    echo "in hold w: $IN_HOLD_W"
    echo "in hold h: $IN_HOLD_H"
    echo "item x: $originX"
    echo "item y: $originY"
    echo "fname: $fname"

    write_snapshot $IN_HOLD_W $IN_HOLD_H $originX $originY $fname
}

#
# Store SHAs of 'in hold' state images for later comparison
#
store_empty_cargo_state() {
    get_current_cargo_state

    foodSHAEmpty=$foodSHA
    textilesSHAEmpty=$textilesSHA
    radioactivesSHAEmpty=$radioactivesSHA
    slavesSHAEmpty=$slavesSHA
    liquorSHAEmpty=$liquorSHA
    luxuriesSHAEmpty=$luxuriesSHA
    narcoticsSHAEmpty=$narcoticsSHA
    computersSHAEmpty=$computersSHA
    machinerySHAEmpty=$machinerySHA
    alloysSHAEmpty=$alloysSHA
    firearmsSHAEmpty=$firearmsSHA
    fursSHAEmpty=$fursSHA
    mineralsSHAEmpty=$mineralsSHA
    goldSHAEmpty=$goldSHA
    platinumSHAEmpty=$platinumSHA
    gemstonesSHAEmpty=$gemstonesSHA
    alienitemsSHAEmpty=$alienitemsSHA
}

food_in_hold() {
    if cargo_hold_contains "food"; then
        echo "There's food in the hold"
    else
        echo "No food in hold"
    fi

    echo $foodSHAEmpty
    echo $foodSHA
}

#
# Return 0 if cargo is in hold, 1 otherwise
# Arg: name of item to test for (ie. "food")
# Ex:
#   if cargo_hold_contains "food"; then
#       do true
#   else
#       do false
#   fi
#
cargo_hold_contains() {
    local item=$1
    # Store the NAME of a variable containing the empty item SHA
    local emptyItemVar="${item}SHAEmpty"
    # Store the NAME of a variable containing the current item SHA
    local currItemVar="${item}SHA"
    # Get the SHA from the value of the variable named emptyItemVar
    local emptyItem=${!emptyItemVar}
    # Get the SHA from the value of the variable named currItemVar
    local currItem=${!currItemVar}

    if [[ $emptyItem == $currItem ]]; then
        return 1 # false
    else
        return 0 # true
    fi
}

doit() {
    pause_shell "Enter after clearing out hold"
    store_empty_cargo_state

    pause_shell "Enter after updating food cargo"

    get_current_cargo_state
    food_in_hold
}

# args: dir to save to (or nothing)
# If dir is provided, it must end with slash: some/dir/
#
dump_market_images() {
    local saveTo=$1
    # Delay to give the image write time to complete
    local delay=1.0

    goto_status
    goto_market
    send_key Down
    cap_to_img $ITEM_X $FOOD_Y ${saveTo}food.png
    wait_for $delay
    send_key Up
    cap_to_img $ITEM_X $TEXTILES_Y ${saveTo}textiles.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $RADIOACTIVES_Y ${saveTo}radioactives.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $SLAVES_Y ${saveTo}slaves.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $LIQUOR_Y ${saveTo}liquor.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $LUXURIES_Y ${saveTo}luxuries.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $NARCOTICS_Y ${saveTo}narcotics.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $COMPUTERS_Y ${saveTo}computers.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $MACHINERY_Y ${saveTo}machinery.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $ALLOYS_Y ${saveTo}alloys.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $FIREARMS_Y ${saveTo}firearms.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $FURS_Y ${saveTo}furs.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $MINERALS_Y ${saveTo}minerals.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $GOLD_Y ${saveTo}gold.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $PLATINUM_Y ${saveTo}platinum.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $GEMSTONES_Y ${saveTo}gemstones.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $ALIENITEMS_Y ${saveTo}alienitems.png
}

#dump_market_images $1
doit

