#!/usr/bin/env bash

source bot-funcs.sh

echo "bot-test"
echo

init_oolite_window

pause_shell "Press [Enter] when you're ready"

IN_HOLD_W=25
IN_HOLD_H=18

ITEM_X=551
ITEM_Y=130
FOOD_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
TEXTILES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
RADIOACTIVES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
SLAVES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
LIQUOR_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H + 1))
LUXURIES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
NARCOTICS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
COMPUTERS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
MACHINERY_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
ALLOYS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
FIREARMS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H + 1))
FURS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
MINERALS_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
GOLD_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
PLATINUM_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H))
GEMSTONES_Y=$ITEM_Y
((ITEM_Y += IN_HOLD_H + 1))
ALIENITEMS_Y=$ITEM_Y

capture_cargo_in_hold() {
    FOOD_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $FOOD_Y)
    TEXTILES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $TEXTILES_Y)
    RADIOACTIVES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $RADIOACTIVES_Y)
    SLAVES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $SLAVES_Y)
    LIQUOR_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $LIQUOR_Y)
    LUXURIES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $LUXURIES_Y)


    NARCOTICS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $NARCOTICS_Y)
    COMPUTERS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $COMPUTERS_Y)
    MACHINERY_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $MACHINERY_Y)
    ALLOYS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $ALLOYS_Y)
    FIREARMS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $FIREARMS_Y)
    FURS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $FURS_Y)
    MINERALS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $MINERALS_Y)
    GOLD_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $GOLD_Y)
    PLATINUM_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $PLATINUM_Y)
    GEMSTONES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $GEMSTONES_Y)
    ALIENITEMS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $ALIENITEMS_Y)
}

capture_cargo_in_hold2() {
    FOOD_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $FOOD_Y | sha256sum)
    TEXTILES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $TEXTILES_Y | sha256sum)
    RADIOACTIVES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $RADIOACTIVES_Y | sha256sum)
    SLAVES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $SLAVES_Y | sha256sum)
    LIQUOR_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $LIQUOR_Y | sha256sum)
    LUXURIES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $LUXURIES_Y | sha256sum)
    NARCOTICS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $NARCOTICS_Y | sha256sum)
    COMPUTERS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $COMPUTERS_Y | sha256sum)
    MACHINERY_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $MACHINERY_Y | sha256sum)
    ALLOYS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $ALLOYS_Y | sha256sum)
    FIREARMS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $FIREARMS_Y | sha256sum)
    FURS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $FURS_Y | sha256sum)
    MINERALS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $MINERALS_Y | sha256sum)
    GOLD_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $GOLD_Y | sha256sum)
    PLATINUM_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $PLATINUM_Y | sha256sum)
    GEMSTONES_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $GEMSTONES_Y | sha256sum)
    ALIENITEMS_IMG=$(capture_snapshot $IN_HOLD_W $IN_HOLD_H $ITEM_X $ALIENITEMS_Y | sha256sum)
}


write_snapshot() {
    # Store the args in named vars
    local width=$1
    local height=$2
    local originX=$3
    local originY=$4
    local fname=$5

    local cropStr="${width}x${height}+${originX}+${originY}"

    # Capture a snapshot of the window
    xwd -name "$WIN_NAME" -silent | convert xwd:- -depth 8 -crop $cropStr $fname
}

cap_to_img() {
    local originX=$1
    local originY=$2
    local fname=$3
    echo "in hold w: $IN_HOLD_W"
    echo "in hold h: $IN_HOLD_H"
    echo "item x: $originX"
    echo "item y: $originY"
    echo "fname: $fname"

    write_snapshot $IN_HOLD_W $IN_HOLD_H $originX $originY $fname
}

store_cargo_images() {
    ORIG_FOOD_IMG=$FOOD_IMG
    ORIG_TEXTILES_IMG=$TEXTILES_IMG
    ORIG_RADIOACTIVES_IMG=$RADIOACTIVES_IMG
    ORIG_SLAVES_IMG=$SLAVES_IMG
    ORIG_LIQUOR_IMG=$LIQUOR_IMG
    ORIG_LUXURIES_IMG=$LUXURIES_IMG
    ORIG_NARCOTICS_IMG=$NARCOTICS_IMG
    ORIG_COMPUTERS_IMG=$COMPUTERS_IMG
    ORIG_MACHINERY_IMG=$MACHINERY_IMG
    ORIG_ALLOYS_IMG=$ALLOYS_IMG
    ORIG_FIREARMS_IMG=$FIREARMS_IMG
    ORIG_FURS_IMG=$FURS_IMG
    ORIG_MINERALS_IMG=$MINERALS_IMG
    ORIG_GOLD_IMG=$GOLD_IMG
    ORIG_PLATINUM_IMG=$PLATINUM_IMG
    ORIG_GEMSTONES_IMG=$GEMSTONES_IMG
    ORIG_ALIENITEMS_IMG=$ALIENITEMS_IMG
}

food_in_hold() {
    if [[ $ORIG_FOOD_IMG == $FOOD_IMG ]]; then
        echo "No change to food"
        echo $ORIG_FOOD_IMG
        echo $FOOD_IMG
    else
        echo "Food is different"
        echo $ORIG_FOOD_IMG
        echo $FOOD_IMG
    fi
}

doit() {
    pause_shell "Enter after updating food cargo (start)"
    capture_cargo_in_hold2
    cap_to_img $ITEM_X $RADIOACTIVES_Y radioactives.png
    store_cargo_images

    pause_shell "Enter after updating food cargo (final)"

    capture_cargo_in_hold2
    cap_to_img $ITEM_X $RADIOACTIVES_Y radioactives2.png
    food_in_hold
}

# args: dir to save to (or nothing)
# If dir is provided, it must end with slash: some/dir/
#
dump_market_images() {
    local saveTo=$1
    local delay=0.5

    goto_status
    goto_market
    send_key Down
    cap_to_img $ITEM_X $FOOD_Y ${saveTo}food.png
    wait_for $delay
    send_key Up
    cap_to_img $ITEM_X $TEXTILES_Y ${saveTo}textiles.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $RADIOACTIVES_Y ${saveTo}radioactives.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $SLAVES_Y ${saveTo}slaves.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $LIQUOR_Y ${saveTo}liquor.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $LUXURIES_Y ${saveTo}luxuries.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $NARCOTICS_Y ${saveTo}narcotics.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $COMPUTERS_Y ${saveTo}computers.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $MACHINERY_Y ${saveTo}machinery.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $ALLOYS_Y ${saveTo}alloys.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $FIREARMS_Y ${saveTo}firearms.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $FURS_Y ${saveTo}furs.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $MINERALS_Y ${saveTo}minerals.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $GOLD_Y ${saveTo}gold.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $PLATINUM_Y ${saveTo}platinum.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $GEMSTONES_Y ${saveTo}gemstones.png
    wait_for $delay
    send_key Down
    cap_to_img $ITEM_X $ALIENITEMS_Y ${saveTo}alienitems.png
}

dump_market_images $1

